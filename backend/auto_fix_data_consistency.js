const { query } = require('./config/database');

async function autoFixDataConsistency() {
  try {
    console.log('ğŸ”§ è‡ªåŠ¨ä¿®å¤æ•°æ®ä¸€è‡´æ€§é—®é¢˜');
    console.log('=====================================\n');

    // æ­¥éª¤1: æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡æ•°æ®
    console.log('ğŸ“ æ­¥éª¤1: æ¸…ç©ºæ‰€æœ‰ç°æœ‰ä»»åŠ¡æ•°æ®...');
    await query('DELETE FROM tasks');
    await query('DELETE FROM leave_records');
    await query('DELETE FROM task_schedule_history');
    console.log('âœ… æ‰€æœ‰ä»»åŠ¡æ•°æ®å·²æ¸…ç©º\n');

    // æ­¥éª¤2: å‡†å¤‡ç®¡ç†å‘˜ç•Œé¢é¢„å¡«çš„CSVæ•°æ®
    console.log('ğŸ“‹ æ­¥éª¤2: å‡†å¤‡ç®¡ç†å‘˜é¢„å¡«çš„æ ‡å‡†CSVæ•°æ®...');
    
    const csvData = `å­¦ç”ŸID,æ—¥æœŸ,ä»»åŠ¡ç±»å‹,ä»»åŠ¡æ ‡é¢˜
ST001,2025-07-01,ä¸“ä¸šè¯¾,æ•°æ®ç»“æ„ä¸ç®—æ³•åŸºç¡€
ST001,2025-07-01,æ•°å­¦,é«˜ç­‰æ•°å­¦å¾®åˆ†å­¦
ST001,2025-07-01,è‹±è¯­,è€ƒç ”è¯æ±‡Unit1-10
ST002,2025-07-01,ä¸“ä¸šè¯¾,æ•°æ®ç»“æ„ä¸ç®—æ³•åŸºç¡€
ST002,2025-07-01,æ•°å­¦,é«˜ç­‰æ•°å­¦å¾®åˆ†å­¦
ST002,2025-07-01,è‹±è¯­,è€ƒç ”è¯æ±‡Unit1-10
ST001,2025-07-02,ä¸“ä¸šè¯¾,æ“ä½œç³»ç»Ÿè¿›ç¨‹ç®¡ç†
ST001,2025-07-02,æ•°å­¦,é«˜ç­‰æ•°å­¦ç§¯åˆ†å­¦
ST001,2025-07-02,è‹±è¯­,é˜…è¯»ç†è§£ä¸“é¡¹è®­ç»ƒ
ST002,2025-07-02,ä¸“ä¸šè¯¾,æ“ä½œç³»ç»Ÿè¿›ç¨‹ç®¡ç†
ST002,2025-07-02,æ•°å­¦,é«˜ç­‰æ•°å­¦ç§¯åˆ†å­¦
ST002,2025-07-02,è‹±è¯­,é˜…è¯»ç†è§£ä¸“é¡¹è®­ç»ƒ
ST001,2025-07-03,ä¸“ä¸šè¯¾,è®¡ç®—æœºç½‘ç»œTCP/IP
ST001,2025-07-03,æ•°å­¦,çº¿æ€§ä»£æ•°çŸ©é˜µè¿ç®—
ST001,2025-07-03,è‹±è¯­,å†™ä½œæŠ€å·§è®­ç»ƒ
ST002,2025-07-03,ä¸“ä¸šè¯¾,è®¡ç®—æœºç½‘ç»œTCP/IP
ST002,2025-07-03,æ•°å­¦,çº¿æ€§ä»£æ•°çŸ©é˜µè¿ç®—
ST002,2025-07-03,è‹±è¯­,å†™ä½œæŠ€å·§è®­ç»ƒ
ST001,2025-07-04,ä¸“ä¸šè¯¾,æ•°æ®åº“ç³»ç»ŸåŸç†
ST001,2025-07-04,æ•°å­¦,æ¦‚ç‡è®ºåŸºç¡€æ¦‚å¿µ
ST001,2025-07-04,è‹±è¯­,ç¿»è¯‘æŠ€å·§ç»ƒä¹ 
ST002,2025-07-04,ä¸“ä¸šè¯¾,æ•°æ®åº“ç³»ç»ŸåŸç†
ST002,2025-07-04,æ•°å­¦,æ¦‚ç‡è®ºåŸºç¡€æ¦‚å¿µ
ST002,2025-07-04,è‹±è¯­,ç¿»è¯‘æŠ€å·§ç»ƒä¹ 
ST001,2025-07-06,ä¼‘æ¯,å‘¨æ—¥ä¼‘æ¯æ—¥
ST002,2025-07-06,ä¼‘æ¯,å‘¨æ—¥ä¼‘æ¯æ—¥
ST001,2025-07-06,ä¸“ä¸šè¯¾,ç¼–è¯‘åŸç†è¯æ³•åˆ†æ
ST001,2025-07-06,æ•°å­¦,ç¦»æ•£æ•°å­¦å›¾è®º
ST001,2025-07-06,è‹±è¯­,è¯­æ³•ä¸“é¡¹å¤ä¹ 
ST002,2025-07-06,ä¸“ä¸šè¯¾,ç¼–è¯‘åŸç†è¯æ³•åˆ†æ
ST002,2025-07-06,æ•°å­¦,ç¦»æ•£æ•°å­¦å›¾è®º
ST002,2025-07-06,è‹±è¯­,è¯­æ³•ä¸“é¡¹å¤ä¹ 
ST001,2025-07-07,ä¸“ä¸šè¯¾,äººå·¥æ™ºèƒ½æœºå™¨å­¦ä¹ 
ST001,2025-07-07,æ•°å­¦,æ•°å€¼åˆ†ææ–¹æ³•
ST001,2025-07-07,è‹±è¯­,å®Œå½¢å¡«ç©ºç»ƒä¹ 
ST002,2025-07-07,ä¸“ä¸šè¯¾,äººå·¥æ™ºèƒ½æœºå™¨å­¦ä¹ 
ST002,2025-07-07,æ•°å­¦,æ•°å€¼åˆ†ææ–¹æ³•
ST002,2025-07-07,è‹±è¯­,å®Œå½¢å¡«ç©ºç»ƒä¹ 
ST001,2025-07-08,ä¸“ä¸šè¯¾,è®¡ç®—æœºç»„æˆåŸç†
ST001,2025-07-08,æ•°å­¦,å¤å˜å‡½æ•°åŸºç¡€
ST001,2025-07-08,è‹±è¯­,æ–°é¢˜å‹è®­ç»ƒ
ST002,2025-07-08,ä¸“ä¸šè¯¾,è®¡ç®—æœºç»„æˆåŸç†
ST002,2025-07-08,æ•°å­¦,å¤å˜å‡½æ•°åŸºç¡€
ST002,2025-07-08,è‹±è¯­,æ–°é¢˜å‹è®­ç»ƒ
ST001,2025-07-09,ä¸“ä¸šè¯¾,ç®—æ³•è®¾è®¡ä¸åˆ†æ
ST001,2025-07-09,æ•°å­¦,å®å˜å‡½æ•°ç†è®º
ST001,2025-07-09,è‹±è¯­,è€ƒç ”çœŸé¢˜æ¼”ç»ƒ
ST002,2025-07-09,ä¸“ä¸šè¯¾,ç®—æ³•è®¾è®¡ä¸åˆ†æ
ST002,2025-07-09,æ•°å­¦,å®å˜å‡½æ•°ç†è®º
ST002,2025-07-09,è‹±è¯­,è€ƒç ”çœŸé¢˜æ¼”ç»ƒ
ST001,2025-07-10,ä¸“ä¸šè¯¾,å®¹å™¨åŒ–æŠ€æœ¯Docker
ST001,2025-07-10,æ•°å­¦,ä»£æ•°å‡ ä½•åŸºç¡€
ST001,2025-07-10,è‹±è¯­,å•†åŠ¡è‹±è¯­è¡¨è¾¾
ST002,2025-07-10,ä¸“ä¸šè¯¾,å®¹å™¨åŒ–æŠ€æœ¯Docker
ST002,2025-07-10,æ•°å­¦,ä»£æ•°å‡ ä½•åŸºç¡€
ST002,2025-07-10,è‹±è¯­,å•†åŠ¡è‹±è¯­è¡¨è¾¾`;

    console.log('âœ… CSVæ•°æ®å‡†å¤‡å®Œæˆ\n');

    // æ­¥éª¤3: è§£æå¹¶å¯¼å…¥CSVæ•°æ®
    console.log('ğŸ“¥ æ­¥éª¤3: è§£æå¹¶å¯¼å…¥CSVæ•°æ®...');
    
    const lines = csvData.trim().split('\n').slice(1); // è·³è¿‡æ ‡é¢˜è¡Œ
    const tasks = [];
    
    for (const line of lines) {
      if (!line.trim()) continue;
      
      const parts = line.split(',');
      if (parts.length < 4) continue;

      const [studentId, dateStr, taskType, ...contentParts] = parts.map(item => item.trim());
      const content = contentParts.join(',');

      if (!studentId || !dateStr || !content) continue;

      // éªŒè¯æ—¥æœŸæ ¼å¼
      const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
      if (!dateRegex.test(dateStr)) {
        console.warn(`æ— æ•ˆæ—¥æœŸæ ¼å¼ï¼Œè·³è¿‡è¡Œ: ${line}`);
        continue;
      }

      // éªŒè¯å­¦ç”Ÿæ˜¯å¦å­˜åœ¨
      const students = await query('SELECT id FROM students WHERE id = ?', [studentId]);
      if (students.length === 0) {
        console.warn(`å­¦ç”Ÿä¸å­˜åœ¨ï¼Œè·³è¿‡è¡Œ: ${line}`);
        continue;
      }

      // ç”Ÿæˆå”¯ä¸€ä»»åŠ¡ID
      const taskId = `${studentId}-${dateStr}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
      
      tasks.push({
        id: taskId,
        student_id: studentId,
        task_date: dateStr,
        task_type: taskType,
        title: content,
        completed: false
      });
    }

    // æ‰¹é‡æ’å…¥ä»»åŠ¡
    let imported = 0;
    for (const task of tasks) {
      await query(
        'INSERT INTO tasks (id, student_id, task_date, task_type, title, completed) VALUES (?, ?, ?, ?, ?, ?)',
        [task.id, task.student_id, task.task_date, task.task_type, task.title, task.completed]
      );
      imported++;
    }

    console.log(`âœ… æˆåŠŸå¯¼å…¥ ${imported} ä¸ªä»»åŠ¡\n`);

    // æ­¥éª¤4: éªŒè¯å¯¼å…¥ç»“æœ
    console.log('ğŸ” æ­¥éª¤4: éªŒè¯å¯¼å…¥ç»“æœ...');
    
    // æŸ¥è¯¢ST001å­¦ç”Ÿ7æœˆ1-10æ—¥çš„ä»»åŠ¡
    const st001Tasks = await query(`
      SELECT student_id, task_date, task_type, title 
      FROM tasks 
      WHERE student_id = 'ST001' 
        AND task_date BETWEEN '2025-07-01' AND '2025-07-10' 
      ORDER BY task_date, task_type
    `);

    console.log(`ST001å­¦ç”Ÿä»»åŠ¡æ•°é‡: ${st001Tasks.length}`);
    
    // é¢„æœŸçš„ST001ä»»åŠ¡æ•°æ®ï¼ˆä»CSVä¸­æå–ï¼‰
    const expectedST001Tasks = [
      ['2025-07-01', 'ä¸“ä¸šè¯¾', 'æ•°æ®ç»“æ„ä¸ç®—æ³•åŸºç¡€'],
      ['2025-07-01', 'æ•°å­¦', 'é«˜ç­‰æ•°å­¦å¾®åˆ†å­¦'],
      ['2025-07-01', 'è‹±è¯­', 'è€ƒç ”è¯æ±‡Unit1-10'],
      ['2025-07-02', 'ä¸“ä¸šè¯¾', 'æ“ä½œç³»ç»Ÿè¿›ç¨‹ç®¡ç†'],
      ['2025-07-02', 'æ•°å­¦', 'é«˜ç­‰æ•°å­¦ç§¯åˆ†å­¦'],
      ['2025-07-02', 'è‹±è¯­', 'é˜…è¯»ç†è§£ä¸“é¡¹è®­ç»ƒ'],
      ['2025-07-03', 'ä¸“ä¸šè¯¾', 'è®¡ç®—æœºç½‘ç»œTCP/IP'],
      ['2025-07-03', 'æ•°å­¦', 'çº¿æ€§ä»£æ•°çŸ©é˜µè¿ç®—'],
      ['2025-07-03', 'è‹±è¯­', 'å†™ä½œæŠ€å·§è®­ç»ƒ'],
      ['2025-07-04', 'ä¸“ä¸šè¯¾', 'æ•°æ®åº“ç³»ç»ŸåŸç†'],
      ['2025-07-04', 'æ•°å­¦', 'æ¦‚ç‡è®ºåŸºç¡€æ¦‚å¿µ'],
      ['2025-07-04', 'è‹±è¯­', 'ç¿»è¯‘æŠ€å·§ç»ƒä¹ '],
      ['2025-07-06', 'ä¼‘æ¯', 'å‘¨æ—¥ä¼‘æ¯æ—¥'],
      ['2025-07-06', 'ä¸“ä¸šè¯¾', 'ç¼–è¯‘åŸç†è¯æ³•åˆ†æ'],
      ['2025-07-06', 'æ•°å­¦', 'ç¦»æ•£æ•°å­¦å›¾è®º'],
      ['2025-07-06', 'è‹±è¯­', 'è¯­æ³•ä¸“é¡¹å¤ä¹ '],
      ['2025-07-07', 'ä¸“ä¸šè¯¾', 'äººå·¥æ™ºèƒ½æœºå™¨å­¦ä¹ '],
      ['2025-07-07', 'æ•°å­¦', 'æ•°å€¼åˆ†ææ–¹æ³•'],
      ['2025-07-07', 'è‹±è¯­', 'å®Œå½¢å¡«ç©ºç»ƒä¹ '],
      ['2025-07-08', 'ä¸“ä¸šè¯¾', 'è®¡ç®—æœºç»„æˆåŸç†'],
      ['2025-07-08', 'æ•°å­¦', 'å¤å˜å‡½æ•°åŸºç¡€'],
      ['2025-07-08', 'è‹±è¯­', 'æ–°é¢˜å‹è®­ç»ƒ'],
      ['2025-07-09', 'ä¸“ä¸šè¯¾', 'ç®—æ³•è®¾è®¡ä¸åˆ†æ'],
      ['2025-07-09', 'æ•°å­¦', 'å®å˜å‡½æ•°ç†è®º'],
      ['2025-07-09', 'è‹±è¯­', 'è€ƒç ”çœŸé¢˜æ¼”ç»ƒ'],
      ['2025-07-10', 'ä¸“ä¸šè¯¾', 'å®¹å™¨åŒ–æŠ€æœ¯Docker'],
      ['2025-07-10', 'æ•°å­¦', 'ä»£æ•°å‡ ä½•åŸºç¡€'],
      ['2025-07-10', 'è‹±è¯­', 'å•†åŠ¡è‹±è¯­è¡¨è¾¾']
    ];

    // éªŒè¯æ•°é‡
    if (st001Tasks.length === expectedST001Tasks.length) {
      console.log('âœ… ä»»åŠ¡æ•°é‡åŒ¹é…');
    } else {
      console.log(`âŒ ä»»åŠ¡æ•°é‡ä¸åŒ¹é…: å®é™…${st001Tasks.length}, é¢„æœŸ${expectedST001Tasks.length}`);
    }

    // éªŒè¯å†…å®¹
    let matchCount = 0;
    for (let i = 0; i < Math.min(st001Tasks.length, expectedST001Tasks.length); i++) {
      const dbTask = st001Tasks[i];
      const expectedTask = expectedST001Tasks[i];
      
      const dbDate = dbTask.task_date.toISOString().split('T')[0];
      const expectedDate = expectedTask[0];
      const dbType = dbTask.task_type;
      const expectedType = expectedTask[1];
      const dbTitle = dbTask.title;
      const expectedTitle = expectedTask[2];

      if (dbDate === expectedDate && dbType === expectedType && dbTitle === expectedTitle) {
        matchCount++;
      } else {
        console.log(`âŒ ä¸åŒ¹é… ${i + 1}:`);
        console.log(`  å®é™…: ${dbDate} - ${dbType} - ${dbTitle}`);
        console.log(`  é¢„æœŸ: ${expectedDate} - ${expectedType} - ${expectedTitle}`);
      }
    }

    console.log(`ğŸ“Š å†…å®¹åŒ¹é…ç»“æœ: ${matchCount}/${Math.min(st001Tasks.length, expectedST001Tasks.length)}`);

    if (matchCount === expectedST001Tasks.length && st001Tasks.length === expectedST001Tasks.length) {
      console.log('\nğŸ‰ æ•°æ®ä¸€è‡´æ€§ä¿®å¤æˆåŠŸï¼');
      console.log('âœ… ç®¡ç†å‘˜é¢„å¡«æ•°æ®ä¸æ•°æ®åº“æ•°æ®å®Œå…¨ä¸€è‡´');
      console.log('âœ… å­¦ç”Ÿç«¯å°†æ˜¾ç¤ºä¸ç®¡ç†å‘˜é¢„å¡«å®Œå…¨ç›¸åŒçš„ä»»åŠ¡');
    } else {
      console.log('\nâŒ æ•°æ®ä¸€è‡´æ€§ä¿®å¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥é—®é¢˜');
    }

  } catch (error) {
    console.error('âŒ ä¿®å¤è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯:', error.message);
  }
}

autoFixDataConsistency();
