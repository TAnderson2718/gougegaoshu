{"ast":null,"code":"import React,{useState,useEffect}from'react';import{taskAPI}from'../services/api';import{useApp}from'../contexts/AppContext';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const MonthScreen=()=>{const{systemDate}=useApp();const[tasks,setTasks]=useState([]);const[originalDateStats,setOriginalDateStats]=useState({});const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[selectedDate,setSelectedDate]=useState(null);const[currentMonth,setCurrentMonth]=useState(new Date(systemDate));const[showTaskModal,setShowTaskModal]=useState(false);// 格式化日期为YYYY-MM-DD（避免时区问题）\nconst formatDate=date=>{const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,'0');const day=String(date.getDate()).padStart(2,'0');return`${year}-${month}-${day}`;};// 获取月度任务\nconst fetchMonthTasks=async month=>{try{setLoading(true);setError(null);const startDate=new Date(month.getFullYear(),month.getMonth(),1);const endDate=new Date(month.getFullYear(),month.getMonth()+1,0);const response=await taskAPI.getTasks(formatDate(startDate),formatDate(endDate),'month'// 添加月度视图参数\n);if(response.success){// 后端返回的是按日期分组的对象，需要转换为平面数组\nconst tasksByDate=response.data||{};const allTasks=[];Object.keys(tasksByDate).forEach(date=>{const dateTasks=tasksByDate[date]||[];dateTasks.forEach(task=>{allTasks.push({...task,date:date// 添加日期字段\n});});});setTasks(allTasks);// 保存原始日期统计数据\nsetOriginalDateStats(response.originalDateStats||{});}else{setError(response.message||'获取任务失败');}}catch(err){setError(err.message||'网络错误');}finally{setLoading(false);}};// 获取指定日期的任务\nconst getTasksForDate=date=>{const dateStr=formatDate(date);const taskArray=Array.isArray(tasks)?tasks:[];return taskArray.filter(task=>task.date===dateStr);};// 生成日历数据\nconst generateCalendarDays=()=>{const year=currentMonth.getFullYear();const month=currentMonth.getMonth();const firstDay=new Date(year,month,1);const lastDay=new Date(year,month+1,0);const startDate=new Date(firstDay);startDate.setDate(startDate.getDate()-firstDay.getDay());// 从周日开始\nconst days=[];const current=new Date(startDate);// 生成6周的日期（42天）\nfor(let i=0;i<42;i++){const currentDate=new Date(current);// 创建日期副本\nconst dateStr=formatDate(currentDate);const dayTasks=getTasksForDate(currentDate);// 计算任务完成情况（不计算完成率）\nconst originalStats=originalDateStats[dateStr];let completedTasks,totalTasks;if(originalStats){// 使用原始日期的统计数据\ncompletedTasks=originalStats.completed;totalTasks=originalStats.total;}else{// 如果没有原始统计，使用当前显示的任务\ncompletedTasks=dayTasks.filter(task=>task.completed).length;totalTasks=dayTasks.length;}days.push({date:currentDate,dayNumber:currentDate.getDate(),isCurrentMonth:currentDate.getMonth()===month,isToday:formatDate(currentDate)===formatDate(systemDate),tasks:dayTasks,completedTasks,totalTasks,originalStats// 保存原始统计信息，用于调试\n});current.setDate(current.getDate()+1);}return days;};// 上一个月\nconst previousMonth=()=>{setCurrentMonth(prev=>new Date(prev.getFullYear(),prev.getMonth()-1,1));};// 下一个月\nconst nextMonth=()=>{setCurrentMonth(prev=>new Date(prev.getFullYear(),prev.getMonth()+1,1));};// 选择日期\nconst selectDate=date=>{setSelectedDate(date);setShowTaskModal(true);};// 关闭任务详情弹窗\nconst closeTaskModal=()=>{setShowTaskModal(false);setSelectedDate(null);};// 计算月度统计\nconst getMonthStats=()=>{const taskArray=Array.isArray(tasks)?tasks:[];const monthTasks=taskArray.filter(task=>{const taskDate=new Date(task.date);return taskDate.getMonth()===currentMonth.getMonth()&&taskDate.getFullYear()===currentMonth.getFullYear();});const completed=monthTasks.filter(task=>task.completed).length;const total=monthTasks.length;const totalStudyTimeMinutes=monthTasks.reduce((acc,task)=>{if(task.duration){return acc+task.duration.hour*60+task.duration.minute;}return acc;},0);// 格式化时长显示\nconst formatTotalStudyTime=()=>{if(totalStudyTimeMinutes===0){return'0小时0分钟';}const hours=Math.floor(totalStudyTimeMinutes/60);const minutes=totalStudyTimeMinutes%60;return`${hours}小时${minutes}分钟`;};return{total,completed,totalStudyTime:formatTotalStudyTime()};};useEffect(()=>{fetchMonthTasks(currentMonth);},[currentMonth]);const calendarDays=generateCalendarDays();const monthStats=getMonthStats();const weekDays=['日','一','二','三','四','五','六'];if(loading){return/*#__PURE__*/_jsx(\"div\",{\"data-testid\":\"month-screen\",className:\"p-6\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto\"}),/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-gray-600\",children:\"\\u52A0\\u8F7D\\u4E2D...\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{\"data-testid\":\"month-screen\",className:\"p-6 max-w-7xl mx-auto\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"mb-6\",children:[/*#__PURE__*/_jsx(\"h1\",{className:\"text-2xl font-bold text-gray-800 mb-2\",children:\"\\u6708\\u5EA6\\u4EFB\\u52A1\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-600\",children:\"\\u67E5\\u770B\\u548C\\u7BA1\\u7406\\u6BCF\\u6708\\u7684\\u5B66\\u4E60\\u4EFB\\u52A1\"})]}),error&&/*#__PURE__*/_jsx(\"div\",{className:\"mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-md\",children:error}),/*#__PURE__*/_jsxs(\"div\",{className:\"grid grid-cols-1 lg:grid-cols-4 gap-6\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"lg:col-span-3\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white rounded-lg shadow-md p-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between mb-6\",children:[/*#__PURE__*/_jsxs(\"h2\",{className:\"text-xl font-semibold text-gray-800\",children:[currentMonth.getFullYear(),\"\\u5E74\",currentMonth.getMonth()+1,\"\\u6708\"]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-2\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:previousMonth,className:\"px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300\",children:\"\\u2190 \\u4E0A\\u6708\"}),/*#__PURE__*/_jsx(\"button\",{onClick:nextMonth,className:\"px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300\",children:\"\\u4E0B\\u6708 \\u2192\"})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"grid grid-cols-7 gap-1 mb-2\",children:weekDays.map(day=>/*#__PURE__*/_jsx(\"div\",{className:\"text-center text-sm font-medium text-gray-500 py-2\",children:day},day))}),/*#__PURE__*/_jsx(\"div\",{className:\"grid grid-cols-7 gap-1\",children:calendarDays.map((day,index)=>/*#__PURE__*/_jsx(CalendarDay,{day:day,onSelect:selectDate,isSelected:selectedDate&&formatDate(selectedDate)===formatDate(day.date)},index))})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-6\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white rounded-lg shadow-md p-6\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-semibold text-gray-800 mb-4\",children:\"\\u672C\\u6708\\u7EDF\\u8BA1\"}),/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-3 text-sm\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600\",children:\"\\u603B\\u4EFB\\u52A1\\u6570\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold\",children:monthStats.total})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600\",children:\"\\u5DF2\\u5B8C\\u6210\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-green-600\",children:monthStats.completed})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600\",children:\"\\u672A\\u5B8C\\u6210\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-red-600\",children:monthStats.total-monthStats.completed})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"text-gray-600\",children:\"\\u5B66\\u4E60\\u65F6\\u957F\"}),/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold\",children:monthStats.totalStudyTime})]})]})})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white rounded-lg shadow-md p-6\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-semibold text-gray-800 mb-4\",children:\"\\u72B6\\u6001\\u8BF4\\u660E\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-3 text-sm\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-4 h-4 bg-green-100 border border-green-200 rounded\"}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u6709\\u5B66\\u4E60\\u4EFB\\u52A1\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-4 h-4 bg-yellow-50 border border-yellow-300 rounded\"}),/*#__PURE__*/_jsx(\"span\",{children:\"\\uD83C\\uDFE0 \\u5DF2\\u8BF7\\u5047\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-4 h-4 bg-blue-50 border border-blue-300 rounded\"}),/*#__PURE__*/_jsx(\"span\",{children:\"\\uD83D\\uDE34 \\u4F11\\u606F\\u65E5\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-4 h-4 bg-gray-50 border border-gray-200 rounded\"}),/*#__PURE__*/_jsx(\"span\",{children:\"\\u65E0\\u4EFB\\u52A1\\u5B89\\u6392\"})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white rounded-lg shadow-md p-6\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-semibold text-gray-800 mb-4\",children:\"\\u5FEB\\u901F\\u5BFC\\u822A\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-2\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>{setCurrentMonth(new Date(systemDate));setSelectedDate(systemDate);},className:\"w-full px-3 py-2 text-left text-sm bg-blue-50 text-blue-700 rounded hover:bg-blue-100\",children:\"\\u56DE\\u5230\\u4ECA\\u65E5\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setCurrentMonth(new Date()),className:\"w-full px-3 py-2 text-left text-sm bg-gray-50 text-gray-700 rounded hover:bg-gray-100\",children:\"\\u5F53\\u524D\\u6708\\u4EFD\"})]})]})]})]}),showTaskModal&&selectedDate&&/*#__PURE__*/_jsx(TaskDetailsModal,{date:selectedDate,tasks:getTasksForDate(selectedDate),onClose:closeTaskModal})]});};// 日历单元格组件\nconst CalendarDay=_ref=>{let{day,onSelect,isSelected}=_ref;// 检查是否有请假或休息任务\nconst hasLeaveTask=day.tasks.some(task=>task.type==='leave');const hasRestTask=day.tasks.some(task=>task.type==='休息');const getCompletionColor=()=>{if(hasLeaveTask)return'bg-yellow-50';// 请假日\nif(hasRestTask)return'bg-blue-50';// 休息日\nif(day.totalTasks===0)return'bg-gray-50';// 无任务安排\nreturn'bg-green-100';// 有学习任务\n};const getBorderColor=()=>{if(isSelected)return'border-blue-500 border-2';if(day.isToday)return'border-blue-300 border-2';if(hasLeaveTask)return'border-yellow-300';if(hasRestTask)return'border-blue-300';return'border-gray-200';};const getStatusIcon=()=>{if(hasLeaveTask)return'🏠';// 请假\nif(hasRestTask)return'😴';// 休息\nreturn null;};return/*#__PURE__*/_jsxs(\"div\",{onClick:()=>onSelect(day.date),className:`\n        relative h-24 p-1 border cursor-pointer hover:bg-gray-50 transition-colors\n        ${getBorderColor()}\n        ${getCompletionColor()}\n        ${!day.isCurrentMonth?'opacity-30':''}\n      `,children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex justify-between items-start h-full\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-1\",children:[/*#__PURE__*/_jsx(\"span\",{className:`text-sm font-medium ${day.isToday?'text-blue-600':day.isCurrentMonth?'text-gray-900':'text-gray-400'}`,children:day.dayNumber}),getStatusIcon()&&/*#__PURE__*/_jsx(\"span\",{className:\"text-xs\",children:getStatusIcon()})]}),day.totalTasks>0&&!hasLeaveTask&&!hasRestTask&&/*#__PURE__*/_jsx(\"div\",{className:\"text-right\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-xs font-semibold text-green-600\",children:[day.completedTasks,\"/\",day.totalTasks]})}),hasLeaveTask&&/*#__PURE__*/_jsx(\"div\",{className:\"text-right\",children:/*#__PURE__*/_jsx(\"div\",{className:\"text-xs text-yellow-600 font-semibold\",children:\"\\u5DF2\\u8BF7\\u5047\"})}),hasRestTask&&!hasLeaveTask&&/*#__PURE__*/_jsx(\"div\",{className:\"text-right\",children:/*#__PURE__*/_jsx(\"div\",{className:\"text-xs text-blue-600 font-semibold\",children:\"\\u4F11\\u606F\\u65E5\"})})]}),day.totalTasks>0&&/*#__PURE__*/_jsx(\"div\",{className:\"absolute bottom-1 left-1 right-1\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-1\",children:[Array.from({length:Math.min(day.totalTasks,5)}).map((_,index)=>/*#__PURE__*/_jsx(\"div\",{className:`h-1 flex-1 rounded ${index<day.completedTasks?'bg-green-500':'bg-gray-300'}`},index)),day.totalTasks>5&&/*#__PURE__*/_jsx(\"span\",{className:\"text-xs text-gray-500\",children:\"+\"})]})})]});};// 任务详情弹窗组件\nconst TaskDetailsModal=_ref2=>{let{date,tasks,onClose}=_ref2;return/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white rounded-lg shadow-xl max-w-md w-11/12 max-h-[80vh] overflow-hidden\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"bg-blue-500 text-white px-6 py-4 flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"h2\",{className:\"text-lg font-semibold\",children:[date.getMonth()+1,\"\\u6708\",date.getDate(),\"\\u65E5\\u4EFB\\u52A1\"]}),/*#__PURE__*/_jsx(\"button\",{onClick:onClose,className:\"text-white hover:text-gray-200 text-xl font-bold\",children:\"\\xD7\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"p-6 max-h-96 overflow-y-auto\",children:tasks.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-400 text-4xl mb-3\",children:\"\\uD83D\\uDCDD\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"\\u5F53\\u65E5\\u65E0\\u4EFB\\u52A1\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-3\",children:tasks.map(task=>/*#__PURE__*/_jsx(TaskItem,{task:task},task.id))})}),/*#__PURE__*/_jsx(\"div\",{className:\"bg-gray-50 px-6 py-4 flex justify-end\",children:/*#__PURE__*/_jsx(\"button\",{onClick:onClose,className:\"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600\",children:\"\\u5173\\u95ED\"})})]})});};// 任务项组件\nconst TaskItem=_ref3=>{let{task}=_ref3;// 检查是否是特殊任务类型\nconst isLeaveTask=task.type==='leave';const isRestTask=task.type==='休息';const getTaskTypeDisplay=()=>{if(isLeaveTask)return{text:'已请假',color:'bg-yellow-100 text-yellow-800'};if(isRestTask)return{text:'休息日',color:'bg-blue-100 text-blue-800'};switch(task.type){case'数学':return{text:'数学',color:'bg-blue-100 text-blue-800'};case'英语':return{text:'英语',color:'bg-green-100 text-green-800'};case'专业课':return{text:'专业课',color:'bg-purple-100 text-purple-800'};default:return{text:task.type||'其他',color:'bg-gray-100 text-gray-800'};}};const typeDisplay=getTaskTypeDisplay();return/*#__PURE__*/_jsx(\"div\",{className:`p-4 rounded-lg border ${task.completed?'bg-green-50 border-green-200':isLeaveTask||isRestTask?'bg-gray-50 border-gray-200':'bg-white border-gray-200'}`,children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start space-x-3\",children:[/*#__PURE__*/_jsx(\"div\",{className:`mt-1 w-4 h-4 rounded-full flex items-center justify-center ${task.completed?'bg-green-500 text-white':isLeaveTask||isRestTask?'bg-gray-400':'bg-gray-300'}`,children:task.completed&&/*#__PURE__*/_jsx(\"svg\",{className:\"w-3 h-3\",fill:\"currentColor\",viewBox:\"0 0 20 20\",children:/*#__PURE__*/_jsx(\"path\",{fillRule:\"evenodd\",d:\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\",clipRule:\"evenodd\"})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1\",children:[/*#__PURE__*/_jsx(\"h4\",{className:`font-medium text-sm ${task.completed?'text-green-700 line-through':'text-gray-800'}`,children:isLeaveTask?'🏠 已请假':isRestTask?'😴 休息日':task.title||'任务标题'}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"span\",{className:`px-2 py-1 rounded text-xs ${typeDisplay.color}`,children:typeDisplay.text}),task.completed&&!isLeaveTask&&!isRestTask&&/*#__PURE__*/_jsx(\"span\",{className:\"text-green-600 text-xs\",children:\"\\u2713 \\u5DF2\\u5B8C\\u6210\"})]}),task.duration&&(task.duration.hour>0||task.duration.minute>0)&&/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 text-xs text-gray-600\",children:[\"\\u7528\\u65F6: \",task.duration.hour,\"\\u65F6\",task.duration.minute,\"\\u5206\"]}),task.proof&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-2 text-xs text-green-600\",children:\"\\uD83D\\uDCF7 \\u5DF2\\u4E0A\\u4F20\\u5B8C\\u6210\\u51ED\\u8BC1\"})]})]})});};export default MonthScreen;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}