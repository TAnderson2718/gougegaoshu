{"ast":null,"code":"import React,{useState,useEffect}from'react';import{taskAPI}from'../services/api';import{useApp}from'../contexts/AppContext';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const FutureDaysView=_ref=>{let{onClose}=_ref;const{systemDate}=useApp();const[futureTasks,setFutureTasks]=useState({});const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[currentDayIndex,setCurrentDayIndex]=useState(0);const[futureDates,setFutureDates]=useState([]);// 获取未来几天的任务\nconst fetchFutureTasks=async dates=>{try{setLoading(true);setError(null);if(!dates||dates.length===0){setFutureTasks({});return;}const startDate=dates[0].dateStr;const endDate=dates[dates.length-1].dateStr;const response=await taskAPI.getTasks(startDate,endDate);if(response.success){setFutureTasks(response.data||{});}else{setError(response.message||'获取任务失败');}}catch(err){setError(err.message||'网络错误');}finally{setLoading(false);}};// 更新任务状态（提前完成）\nconst updateTaskStatus=async(taskId,completed)=>{try{const response=await taskAPI.updateTask(taskId,{completed,completedAt:completed?new Date().toISOString():null,completed_date:completed?(()=>{const year=systemDate.getFullYear();const month=String(systemDate.getMonth()+1).padStart(2,'0');const day=String(systemDate.getDate()).padStart(2,'0');return`${year}-${month}-${day}`;})():null,is_future_task:completed// 标记为提前完成的未来任务\n});if(response.success){// 重新获取任务数据\nawait fetchFutureTasks(futureDates);}else{setError(response.message||'更新任务失败');}}catch(err){setError(err.message||'更新任务失败');}};useEffect(()=>{const initializeFutureDates=async()=>{try{// 生成未来工作日的日期（跳过休息日）\nconst generateFutureDatesLocal=async()=>{try{const dates=[];let checkDate=new Date(systemDate);let daysAdded=0;const maxDays=5;// 最多显示5个工作日\nconst maxCheck=15;// 最多检查15天，避免无限循环\nlet checkCount=0;while(daysAdded<maxDays&&checkCount<maxCheck){checkCount++;checkDate.setDate(checkDate.getDate()+1);const dateStr=(()=>{const year=checkDate.getFullYear();const month=String(checkDate.getMonth()+1).padStart(2,'0');const day=String(checkDate.getDate()).padStart(2,'0');return`${year}-${month}-${day}`;})();// 检查这一天是否有任务（包括休息日任务）\nconst response=await taskAPI.getTasks(dateStr,dateStr);if(response.success&&response.data[dateStr]){const dayTasks=response.data[dateStr];// 如果这一天只有休息任务，则跳过\nconst hasNonRestTasks=dayTasks.some(task=>task.type!=='休息');if(hasNonRestTasks){dates.push({date:new Date(checkDate),dateStr:dateStr,displayName:`${checkDate.getMonth()+1}月${checkDate.getDate()}日`,dayName:['周日','周一','周二','周三','周四','周五','周六'][checkDate.getDay()]});daysAdded++;}}else{// 如果没有任务数据，假设是工作日\ndates.push({date:new Date(checkDate),dateStr:dateStr,displayName:`${checkDate.getMonth()+1}月${checkDate.getDate()}日`,dayName:['周日','周一','周二','周三','周四','周五','周六'][checkDate.getDay()]});daysAdded++;}}return dates;}catch(error){console.error('生成未来日期失败:',error);// 如果出错，回退到简单的日期生成\nconst dates=[];for(let i=1;i<=5;i++){const date=new Date(systemDate);date.setDate(date.getDate()+i);dates.push({date:date,dateStr:(()=>{const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,'0');const day=String(date.getDate()).padStart(2,'0');return`${year}-${month}-${day}`;})(),displayName:`${date.getMonth()+1}月${date.getDate()}日`,dayName:['周日','周一','周二','周三','周四','周五','周六'][date.getDay()]});}return dates;}};const dates=await generateFutureDatesLocal();setFutureDates(dates);setCurrentDayIndex(0);// 重置到第一天\nawait fetchFutureTasks(dates);}catch(error){console.error('初始化未来日期失败:',error);setError('初始化失败');}};initializeFutureDates();},[systemDate]);// 滑动处理\nconst handleSwipeLeft=()=>{if(currentDayIndex<futureDates.length-1){setCurrentDayIndex(currentDayIndex+1);}};const handleSwipeRight=()=>{if(currentDayIndex>0){setCurrentDayIndex(currentDayIndex-1);}};const currentDay=futureDates[currentDayIndex];const currentTasks=futureTasks[currentDay===null||currentDay===void 0?void 0:currentDay.dateStr]||[];if(loading||futureDates.length===0){return/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-white z-50 flex items-center justify-center\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto\"}),/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-gray-600\",children:\"\\u52A0\\u8F7D\\u4E2D...\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{className:\"fixed inset-0 bg-white z-50\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"bg-blue-500 text-white p-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:onClose,className:\"text-white\",children:\"\\u2190 \\u8FD4\\u56DE\"}),/*#__PURE__*/_jsx(\"h1\",{className:\"text-lg font-semibold\",children:\"\\u672A\\u6765\\u4EFB\\u52A1\"}),/*#__PURE__*/_jsx(\"div\",{className:\"w-6\"})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"bg-gray-50 px-4 py-3\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:handleSwipeRight,disabled:currentDayIndex===0,className:`p-2 rounded ${currentDayIndex===0?'text-gray-400':'text-blue-600'}`,children:\"\\u25C0\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-lg font-semibold text-gray-800\",children:currentDay===null||currentDay===void 0?void 0:currentDay.displayName}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-sm text-gray-600\",children:[currentDay===null||currentDay===void 0?void 0:currentDay.dayName,\" \\u2022 \\u8FD8\\u6709\",currentDayIndex+1,\"\\u5929\"]})]}),/*#__PURE__*/_jsx(\"button\",{onClick:handleSwipeLeft,disabled:currentDayIndex===futureDates.length-1,className:`p-2 rounded ${currentDayIndex===futureDates.length-1?'text-gray-400':'text-blue-600'}`,children:\"\\u25B6\"})]}),/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-center mt-3 space-x-2\",children:futureDates.map((_,index)=>/*#__PURE__*/_jsx(\"div\",{className:`w-2 h-2 rounded-full ${index===currentDayIndex?'bg-blue-500':'bg-gray-300'}`},index))})]}),error&&/*#__PURE__*/_jsx(\"div\",{className:\"mx-4 mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-md\",children:error}),/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 overflow-y-auto p-4\",children:currentTasks.length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-12\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-400 text-6xl mb-4\",children:\"\\uD83D\\uDDD3\\uFE0F\"}),/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-semibold text-gray-600 mb-2\",children:\"\\u6682\\u65E0\\u4EFB\\u52A1\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"\\u8FD9\\u4E00\\u5929\\u6CA1\\u6709\\u5B89\\u6392\\u4EFB\\u52A1\"})]}):/*#__PURE__*/_jsxs(\"div\",{className:\"space-y-4\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"mb-4 p-3 bg-blue-50 rounded-lg\",children:/*#__PURE__*/_jsxs(\"p\",{className:\"text-blue-800 text-sm\",children:[\"\\uD83D\\uDCA1 \",/*#__PURE__*/_jsx(\"strong\",{children:\"\\u63D0\\u524D\\u5B8C\\u6210\\u8BF4\\u660E\\uFF1A\"}),\" \\u60A8\\u53EF\\u4EE5\\u63D0\\u524D\\u5B8C\\u6210\\u672A\\u6765\\u5DE5\\u4F5C\\u65E5\\u7684\\u4EFB\\u52A1\\u3002 \\u5B8C\\u6210\\u7684\\u4EFB\\u52A1\\u5C06\\u8BB0\\u5F55\\u4E3A\\u4ECA\\u5929\\u5B8C\\u6210\\uFF0C\\u4F46\\u4E0D\\u4F1A\\u5F71\\u54CD\\u539F\\u5B9A\\u7684\\u4EFB\\u52A1\\u5B89\\u6392\\u3002\\u7CFB\\u7EDF\\u4F1A\\u81EA\\u52A8\\u8DF3\\u8FC7\\u4F11\\u606F\\u65E5\\u3002\"]})}),currentTasks.map(task=>/*#__PURE__*/_jsx(FutureTaskCard,{task:task,onStatusChange:updateTaskStatus,currentDate:systemDate,targetDate:currentDay.date},task.id))]})}),/*#__PURE__*/_jsx(\"div\",{className:\"bg-gray-50 p-4 border-t\",children:/*#__PURE__*/_jsx(\"p\",{className:\"text-center text-sm text-gray-600\",children:\"\\u5DE6\\u53F3\\u6ED1\\u52A8\\u67E5\\u770B\\u5176\\u4ED6\\u5DE5\\u4F5C\\u65E5\\u7684\\u4EFB\\u52A1 \\u2022 \\u53EF\\u63D0\\u524D\\u5B8C\\u6210\\u672A\\u6765\\u5DE5\\u4F5C\\u65E5\\u7684\\u4EFB\\u52A1 \\u2022 \\u81EA\\u52A8\\u8DF3\\u8FC7\\u4F11\\u606F\\u65E5\"})})]});};// 未来任务卡片组件\nconst FutureTaskCard=_ref2=>{let{task,onStatusChange,currentDate,targetDate}=_ref2;const[isCompleting,setIsCompleting]=useState(false);const handleStatusToggle=async()=>{if(isCompleting)return;if(!task.completed){// 提前完成确认\nconst confirmed=window.confirm(`确定要提前完成这个任务吗？\\n\\n任务：\"${task.title}\"\\n计划日期：${targetDate.toLocaleDateString('zh-CN')}\\n完成日期：${currentDate.toLocaleDateString('zh-CN')}\\n\\n此操作不可撤销。`);if(!confirmed)return;}setIsCompleting(true);try{await onStatusChange(task.id,!task.completed);}finally{setIsCompleting(false);}};return/*#__PURE__*/_jsx(\"div\",{className:`border rounded-lg p-4 ${task.completed?'bg-green-50 border-green-200':'bg-white border-gray-200'}`,children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start space-x-3\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:handleStatusToggle,disabled:isCompleting,className:`mt-1 w-5 h-5 rounded border-2 flex items-center justify-center ${task.completed?'bg-green-500 border-green-500 text-white':isCompleting?'border-gray-300 cursor-wait':'border-gray-300 hover:border-blue-500'}`,children:isCompleting?/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin w-3 h-3 border border-gray-400 border-t-transparent rounded-full\"}):task.completed&&/*#__PURE__*/_jsx(\"svg\",{className:\"w-3 h-3\",fill:\"currentColor\",viewBox:\"0 0 20 20\",children:/*#__PURE__*/_jsx(\"path\",{fillRule:\"evenodd\",d:\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\",clipRule:\"evenodd\"})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1\",children:[/*#__PURE__*/_jsx(\"h3\",{className:`font-semibold ${task.completed?'text-green-700 line-through':'text-gray-800'}`,children:task.title||'任务标题'}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 flex items-center space-x-4 text-sm\",children:[/*#__PURE__*/_jsx(\"span\",{className:`px-2 py-1 rounded text-xs ${task.type==='数学'?'bg-blue-100 text-blue-800':task.type==='英语'?'bg-green-100 text-green-800':task.type==='专业课'?'bg-purple-100 text-purple-800':task.type==='休息'?'bg-yellow-100 text-yellow-800':'bg-gray-100 text-gray-800'}`,children:task.type||'其他'}),task.completed&&/*#__PURE__*/_jsx(\"span\",{className:\"text-green-600 text-xs\",children:\"\\u2728 \\u5DF2\\u63D0\\u524D\\u5B8C\\u6210\"})]})]})]})});};export default FutureDaysView;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}