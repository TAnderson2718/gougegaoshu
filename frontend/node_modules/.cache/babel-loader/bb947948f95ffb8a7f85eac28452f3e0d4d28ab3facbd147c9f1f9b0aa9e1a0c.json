{"ast":null,"code":"import React,{useState,useEffect}from'react';import{taskAPI}from'../services/api';import{useApp}from'../contexts/AppContext';import FutureDaysView from'./FutureDaysView';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const TodayScreen=()=>{const{systemDate}=useApp();const[tasks,setTasks]=useState([]);const[loading,setLoading]=useState(true);const[error,setError]=useState(null);const[leaveRecords,setLeaveRecords]=useState([]);const[showLeaveConfirm,setShowLeaveConfirm]=useState(false);const[showFutureDays,setShowFutureDays]=useState(false);// 格式化日期为YYYY-MM-DD（避免时区问题）\nconst formatDate=date=>{const year=date.getFullYear();const month=String(date.getMonth()+1).padStart(2,'0');const day=String(date.getDate()).padStart(2,'0');return`${year}-${month}-${day}`;};// 获取今日任务\nconst fetchTodayTasks=async()=>{try{setLoading(true);setError(null);const today=formatDate(systemDate);const response=await taskAPI.getTasks(today,today);if(response.success){// 后端返回的是按日期分组的对象，需要提取今天的任务\nconst todayTasks=response.data[today]||[];setTasks(todayTasks);}else{setError(response.message||'获取任务失败');}}catch(err){setError(err.message||'网络错误');}finally{setLoading(false);}};// 获取请假记录\nconst fetchLeaveRecords=async()=>{try{const response=await taskAPI.getLeaveRecords();if(response.success){setLeaveRecords(response.data||[]);}}catch(err){console.error('获取请假记录失败:',err);}};// 更新任务状态\nconst updateTaskStatus=async(taskId,completed)=>{try{const response=await taskAPI.updateTask(taskId,{completed,completedAt:completed?new Date().toISOString():null});if(response.success){setTasks(prevTasks=>prevTasks.map(task=>task.id===taskId?{...task,completed,completedAt:completed?new Date().toISOString():null}:task));}else{setError(response.message||'更新任务失败');}}catch(err){setError(err.message||'更新任务失败');}};// 更新任务时长\nconst updateTaskDuration=async(taskId,duration)=>{try{const response=await taskAPI.updateTask(taskId,{duration});if(response.success){setTasks(prevTasks=>prevTasks.map(task=>task.id===taskId?{...task,duration}:task));}else{setError(response.message||'更新时长失败');}}catch(err){setError(err.message||'更新时长失败');}};// 显示请假确认弹窗\nconst showLeaveDialog=()=>{setShowLeaveConfirm(true);};// 确认申请请假\nconst confirmRequestLeave=async()=>{try{setShowLeaveConfirm(false);setLoading(true);const today=formatDate(systemDate);const response=await taskAPI.requestLeave(today);if(response.success){await fetchLeaveRecords();await fetchTodayTasks();// 重新获取任务数据\nsetError(null);alert('请假申请成功！今日任务已顺延到明日，所有后续任务自动顺延一天。');}else{setError(response.message||'请假申请失败');}}catch(err){setError(err.message||'请假申请失败');}finally{setLoading(false);}};// 取消请假\nconst cancelRequestLeave=()=>{setShowLeaveConfirm(false);};useEffect(()=>{fetchTodayTasks();fetchLeaveRecords();},[systemDate]);// 检查今日是否已请假\nconst isOnLeaveToday=()=>{const today=formatDate(systemDate);return leaveRecords.some(record=>record.date===today&&record.status==='approved');};// 计算今日完成率\nconst getCompletionRate=()=>{const taskArray=Array.isArray(tasks)?tasks:[];if(taskArray.length===0)return 0;const completedTasks=taskArray.filter(task=>task.completed).length;return Math.round(completedTasks/taskArray.length*100);};// 计算今日总时长\nconst getTotalStudyTime=()=>{const taskArray=Array.isArray(tasks)?tasks:[];const totalMinutes=taskArray.reduce((acc,task)=>{if(task.duration){return acc+task.duration.hour*60+task.duration.minute;}return acc;},0);const hours=Math.floor(totalMinutes/60);const minutes=totalMinutes%60;if(hours===0&&minutes===0){return'未记录';}return`${hours}小时${minutes}分钟`;};if(loading){return/*#__PURE__*/_jsx(\"div\",{\"data-testid\":\"today-screen\",className:\"p-6\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto\"}),/*#__PURE__*/_jsx(\"p\",{className:\"mt-2 text-gray-600\",children:\"\\u52A0\\u8F7D\\u4E2D...\"})]})});}// 检查是否有认证错误\nif(error&&error.includes('令牌')){return/*#__PURE__*/_jsx(\"div\",{\"data-testid\":\"today-screen\",className:\"p-6\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-6xl mb-4\",children:\"\\uD83D\\uDD12\"}),/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-semibold text-gray-600 mb-2\",children:\"\\u9700\\u8981\\u767B\\u5F55\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500 mb-4\",children:\"\\u8BF7\\u5148\\u767B\\u5F55\\u540E\\u67E5\\u770B\\u4EFB\\u52A1\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>window.location.href='/login',className:\"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600\",children:\"\\u524D\\u5F80\\u767B\\u5F55\"})]})});}return/*#__PURE__*/_jsxs(\"div\",{\"data-testid\":\"today-screen\",className:\"p-6 max-w-4xl mx-auto\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"mb-6\",children:[/*#__PURE__*/_jsxs(\"h1\",{className:\"text-2xl font-bold text-gray-800 mb-2\",children:[\"\\u4ECA\\u65E5\\u4EFB\\u52A1 - \",systemDate.toLocaleDateString('zh-CN')]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-sm text-gray-600\",children:[\"\\u5B8C\\u6210\\u7387: \",/*#__PURE__*/_jsxs(\"span\",{className:\"font-semibold text-blue-600\",children:[getCompletionRate(),\"%\"]}),Array.isArray(tasks)&&tasks.length>0&&/*#__PURE__*/_jsxs(\"span\",{className:\"ml-2\",children:[\"(\",tasks.filter(t=>t.completed).length,\"/\",tasks.length,\" \\u9879\\u5B8C\\u6210)\"]}),/*#__PURE__*/_jsxs(\"span\",{className:\"ml-4\",children:[\"\\u7528\\u65F6: \",/*#__PURE__*/_jsx(\"span\",{className:\"font-semibold text-green-600\",children:getTotalStudyTime()})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-2\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:fetchTodayTasks,className:\"px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm\",disabled:loading,children:loading?'刷新中...':'🔄 刷新'}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowFutureDays(true),className:\"px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm\",children:\"\\u672A\\u6765\\u4EFB\\u52A1 \\u2192\"}),!isOnLeaveToday()&&/*#__PURE__*/_jsx(\"button\",{onClick:showLeaveDialog,className:\"px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 text-sm\",children:\"\\u4ECA\\u65E5\\u8BF7\\u5047\"})]})]})]}),error&&/*#__PURE__*/_jsx(\"div\",{className:\"mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-md\",children:error}),isOnLeaveToday()&&/*#__PURE__*/_jsxs(\"div\",{className:\"mb-6 p-4 bg-yellow-100 border border-yellow-400 text-yellow-800 rounded-md\",children:[/*#__PURE__*/_jsx(\"p\",{className:\"font-semibold\",children:\"\\u4ECA\\u65E5\\u5DF2\\u8BF7\\u5047\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-sm\",children:\"\\u60A8\\u4ECA\\u65E5\\u7684\\u8BF7\\u5047\\u7533\\u8BF7\\u5DF2\\u901A\\u8FC7\\uFF0C\\u65E0\\u9700\\u5B8C\\u6210\\u4EFB\\u52A1\\u3002\"})]}),(Array.isArray(tasks)?tasks:[]).length===0?/*#__PURE__*/_jsxs(\"div\",{className:\"text-center py-8\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-gray-400 text-6xl mb-4\",children:\"\\uD83D\\uDCDD\"}),/*#__PURE__*/_jsx(\"h3\",{className:\"text-lg font-semibold text-gray-600 mb-2\",children:\"\\u6682\\u65E0\\u4ECA\\u65E5\\u4EFB\\u52A1\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-500\",children:\"\\u4ECA\\u5929\\u6CA1\\u6709\\u5B89\\u6392\\u4EFB\\u52A1\\uFF0C\\u60A8\\u53EF\\u4EE5\\u4F11\\u606F\\u4E00\\u4E0B\\u3002\"})]}):/*#__PURE__*/_jsx(\"div\",{className:\"space-y-4\",children:(Array.isArray(tasks)?tasks:[]).map(task=>/*#__PURE__*/_jsx(TaskCard,{task:task,onStatusChange:updateTaskStatus,onDurationChange:updateTaskDuration,disabled:isOnLeaveToday()},task.id))}),showLeaveConfirm&&/*#__PURE__*/_jsx(\"div\",{className:\"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50\",children:/*#__PURE__*/_jsx(\"div\",{className:\"bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-md\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"text-center\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"text-6xl mb-4\",children:\"\\u26A0\\uFE0F\"}),/*#__PURE__*/_jsx(\"h3\",{className:\"text-xl font-bold text-gray-800 mb-2\",children:\"\\u786E\\u8BA4\\u8BF7\\u5047\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"text-gray-600 mb-6 text-left space-y-2\",children:[/*#__PURE__*/_jsx(\"p\",{children:\"\\u2022 \\u4ECA\\u65E5\\u6240\\u6709\\u672A\\u5B8C\\u6210\\u4EFB\\u52A1\\u5C06\\u987A\\u5EF6\\u5230\\u660E\\u65E5\"}),/*#__PURE__*/_jsx(\"p\",{children:\"\\u2022 \\u540E\\u7EED\\u6240\\u6709\\u4EFB\\u52A1\\u81EA\\u52A8\\u987A\\u5EF6\\u4E00\\u5929\"}),/*#__PURE__*/_jsx(\"p\",{children:\"\\u2022 \\u5982\\u679C\\u660E\\u65E5\\u662F\\u4F11\\u606F\\u65E5\\uFF0C\\u4EFB\\u52A1\\u5C06\\u8DF3\\u8FC7\\u4F11\\u606F\\u65E5\"}),/*#__PURE__*/_jsx(\"p\",{className:\"text-red-600 font-semibold\",children:\"\\u2022 \\u6B64\\u64CD\\u4F5C\\u4E0D\\u53EF\\u64A4\\u9500\"})]}),/*#__PURE__*/_jsx(\"p\",{className:\"text-lg font-semibold text-gray-800 mb-6\",children:\"\\u662F\\u5426\\u786E\\u8BA4\\u8BF7\\u5047\\uFF1F\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-4\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:cancelRequestLeave,className:\"flex-1 px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600\",children:\"\\u53D6\\u6D88\"}),/*#__PURE__*/_jsx(\"button\",{onClick:confirmRequestLeave,className:\"flex-1 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600\",children:\"\\u786E\\u8BA4\\u8BF7\\u5047\"})]})]})})}),showFutureDays&&/*#__PURE__*/_jsx(FutureDaysView,{onClose:()=>setShowFutureDays(false)})]});};// 任务卡片组件\nconst TaskCard=_ref=>{var _task$duration,_task$duration2;let{task,onStatusChange,onDurationChange,disabled}=_ref;const[duration,setDuration]=useState({hour:((_task$duration=task.duration)===null||_task$duration===void 0?void 0:_task$duration.hour)||0,minute:((_task$duration2=task.duration)===null||_task$duration2===void 0?void 0:_task$duration2.minute)||0});const[isEditing,setIsEditing]=useState(false);const[showImageUpload,setShowImageUpload]=useState(false);const[selectedImage,setSelectedImage]=useState(null);const[imagePreview,setImagePreview]=useState(task.proof||null);const handleStatusToggle=()=>{if(disabled)return;onStatusChange(task.id,!task.completed);};const handleDurationSave=()=>{onDurationChange(task.id,duration);setIsEditing(false);};const formatDuration=()=>{if(!task.duration||task.duration.hour===0&&task.duration.minute===0){return'未记录';}return`${task.duration.hour}小时${task.duration.minute}分钟`;};// 处理图片选择\nconst handleImageSelect=event=>{const file=event.target.files[0];if(file){// 检查文件大小（限制为5MB）\nif(file.size>5*1024*1024){alert('图片大小不能超过5MB');return;}// 检查文件类型\nif(!file.type.startsWith('image/')){alert('请选择图片文件');return;}setSelectedImage(file);// 创建预览\nconst reader=new FileReader();reader.onload=e=>{setImagePreview(e.target.result);};reader.readAsDataURL(file);}};// 上传图片\nconst handleImageUpload=async()=>{if(!selectedImage)return;try{const reader=new FileReader();reader.onload=async e=>{const base64Image=e.target.result;// 调用API上传图片\nawait updateTaskProof(task.id,base64Image);setShowImageUpload(false);setSelectedImage(null);};reader.readAsDataURL(selectedImage);}catch(error){console.error('图片上传失败:',error);alert('图片上传失败，请重试');}};// 更新任务凭证\nconst updateTaskProof=async(taskId,proofImage)=>{try{const response=await taskAPI.updateTask(taskId,{proof:proofImage});if(response.success){// 更新本地状态\nsetImagePreview(proofImage);}else{throw new Error(response.message||'上传失败');}}catch(error){throw error;}};return/*#__PURE__*/_jsx(\"div\",{className:`border rounded-lg p-4 ${task.completed?'bg-green-50 border-green-200':disabled?'bg-gray-50 border-gray-200':'bg-white border-gray-200'} ${disabled?'opacity-60':''}`,children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start justify-between\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start space-x-3 flex-1\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:handleStatusToggle,disabled:disabled,className:`mt-1 w-5 h-5 rounded border-2 flex items-center justify-center ${task.completed?'bg-green-500 border-green-500 text-white':disabled?'border-gray-300 cursor-not-allowed':'border-gray-300 hover:border-blue-500'}`,children:task.completed&&/*#__PURE__*/_jsx(\"svg\",{className:\"w-3 h-3\",fill:\"currentColor\",viewBox:\"0 0 20 20\",children:/*#__PURE__*/_jsx(\"path\",{fillRule:\"evenodd\",d:\"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z\",clipRule:\"evenodd\"})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1\",children:[/*#__PURE__*/_jsx(\"h3\",{className:`font-semibold ${task.completed?'text-green-700 line-through':'text-gray-800'}`,children:task.title||'任务标题'}),task.description&&/*#__PURE__*/_jsx(\"p\",{className:\"text-gray-600 text-sm mt-1\",children:task.description}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 flex items-center space-x-4 text-sm\",children:[/*#__PURE__*/_jsx(\"span\",{className:`px-2 py-1 rounded text-xs ${task.type==='数学'?'bg-blue-100 text-blue-800':task.type==='英语'?'bg-green-100 text-green-800':task.type==='专业课'?'bg-purple-100 text-purple-800':task.type==='休息'?'bg-yellow-100 text-yellow-800':'bg-gray-100 text-gray-800'}`,children:task.type||'其他'}),task.completed&&task.completedAt&&/*#__PURE__*/_jsxs(\"span\",{className:\"text-green-600\",children:[\"\\u5B8C\\u6210\\u4E8E: \",new Date(task.completedAt).toLocaleTimeString('zh-CN')]}),imagePreview&&/*#__PURE__*/_jsx(\"span\",{className:\"text-green-600 text-xs\",children:\"\\uD83D\\uDCF7 \\u5DF2\\u4E0A\\u4F20\\u51ED\\u8BC1\"})]}),task.completed&&/*#__PURE__*/_jsx(\"div\",{className:\"mt-3\",children:!showImageUpload?/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center space-x-2\",children:imagePreview?/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"img\",{src:imagePreview,alt:\"\\u4EFB\\u52A1\\u51ED\\u8BC1\",className:\"w-16 h-16 object-cover rounded border cursor-pointer\",onClick:()=>{// 点击查看大图\nconst newWindow=window.open();newWindow.document.write(`<img src=\"${imagePreview}\" style=\"max-width:100%; max-height:100%;\" />`);}}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowImageUpload(true),className:\"text-blue-600 text-xs hover:text-blue-800\",children:\"\\u66F4\\u6362\\u51ED\\u8BC1\"})]}):/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowImageUpload(true),className:\"px-3 py-1 bg-green-500 text-white rounded text-xs hover:bg-green-600\",disabled:disabled,children:\"\\uD83D\\uDCF7 \\u4E0A\\u4F20\\u5B8C\\u6210\\u51ED\\u8BC1\"})}):/*#__PURE__*/_jsx(\"div\",{className:\"border rounded p-3 bg-gray-50\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex flex-col space-y-2\",children:[/*#__PURE__*/_jsx(\"input\",{type:\"file\",accept:\"image/*\",onChange:handleImageSelect,className:\"text-xs\"}),selectedImage&&/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"img\",{src:imagePreview,alt:\"\\u9884\\u89C8\",className:\"w-16 h-16 object-cover rounded border\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-2\",children:[/*#__PURE__*/_jsx(\"button\",{onClick:handleImageUpload,className:\"px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600\",children:\"\\u786E\\u8BA4\\u4E0A\\u4F20\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>{setShowImageUpload(false);setSelectedImage(null);setImagePreview(task.proof||null);},className:\"px-3 py-1 bg-gray-500 text-white rounded text-xs hover:bg-gray-600\",children:\"\\u53D6\\u6D88\"})]})]})]})})})]})]}),/*#__PURE__*/_jsx(\"div\",{className:\"ml-4\",children:isEditing?/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[/*#__PURE__*/_jsx(\"select\",{value:duration.hour,onChange:e=>setDuration({...duration,hour:parseInt(e.target.value)}),className:\"w-16 px-2 py-1 border rounded text-sm bg-white\",children:Array.from({length:24},(_,i)=>/*#__PURE__*/_jsx(\"option\",{value:i,children:i},i))}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm\",children:\"\\u65F6\"}),/*#__PURE__*/_jsx(\"select\",{value:duration.minute,onChange:e=>setDuration({...duration,minute:parseInt(e.target.value)}),className:\"w-16 px-2 py-1 border rounded text-sm bg-white\",children:Array.from({length:12},(_,i)=>/*#__PURE__*/_jsx(\"option\",{value:i*5,children:i*5},i*5))}),/*#__PURE__*/_jsx(\"span\",{className:\"text-sm\",children:\"\\u5206\"}),/*#__PURE__*/_jsx(\"button\",{onClick:handleDurationSave,className:\"px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600\",children:\"\\u4FDD\\u5B58\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setIsEditing(false),className:\"px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600\",children:\"\\u53D6\\u6D88\"})]}):/*#__PURE__*/_jsxs(\"div\",{className:\"text-right\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"text-sm text-gray-600 mb-1\",children:[\"\\u7528\\u65F6: \",formatDuration()]}),!disabled&&/*#__PURE__*/_jsx(\"button\",{onClick:()=>setIsEditing(true),className:\"text-xs text-blue-600 hover:text-blue-800\",children:\"\\u7F16\\u8F91\\u65F6\\u957F\"})]})})]})});};export default TodayScreen;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}