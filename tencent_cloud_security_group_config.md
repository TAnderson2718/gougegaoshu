# 腾讯云安全组配置指南

## 问题诊断
根据测试结果，服务在服务器内部运行正常，但外部无法访问。这通常是安全组配置问题。

## 解决步骤

### 1. 登录腾讯云控制台
1. 访问 https://console.cloud.tencent.com/
2. 登录你的腾讯云账号
3. 进入 **云服务器 CVM** 控制台

### 2. 找到你的服务器实例
1. 在实例列表中找到你的服务器 (IP: 114.92.153.131)
2. 记录实例ID和安全组信息

### 3. 配置安全组规则

#### 方法一：通过实例页面配置
1. 点击实例ID进入详情页
2. 点击 **安全组** 标签
3. 点击安全组ID进入安全组管理页面

#### 方法二：直接进入安全组管理
1. 在左侧菜单选择 **安全组**
2. 找到你的安全组并点击 **修改规则**

### 4. 添加入站规则

需要添加以下入站规则：

| 类型 | 协议端口 | 来源 | 策略 | 备注 |
|------|----------|------|------|------|
| 自定义 | TCP:80 | 0.0.0.0/0 | 允许 | 前端HTTP访问 |
| 自定义 | TCP:3001 | 0.0.0.0/0 | 允许 | 后端API访问 |
| 自定义 | TCP:3307 | 0.0.0.0/0 | 允许 | MySQL外部访问(可选) |
| 自定义 | TCP:22 | 0.0.0.0/0 | 允许 | SSH访问 |

#### 具体操作步骤：
1. 点击 **添加规则**
2. 选择 **类型**: 自定义
3. 填写 **协议端口**: TCP:80
4. 填写 **来源**: 0.0.0.0/0
5. 选择 **策略**: 允许
6. 填写 **备注**: 前端HTTP访问
7. 点击 **完成**
8. 重复以上步骤添加其他端口

### 5. 验证配置

配置完成后，等待1-2分钟让规则生效，然后测试：

```bash
# 测试前端访问
curl -I http://114.92.153.131/

# 测试后端API
curl http://114.92.153.131:3001/health

# 测试登录API
curl -X POST http://114.92.153.131:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"userId": "ST001", "password": "Hello888"}'
```

## 常见问题排查

### 1. 规则不生效
- 等待1-2分钟让规则生效
- 检查规则是否正确保存
- 确认选择了正确的安全组

### 2. 仍然无法访问
- 检查服务器内部防火墙: `sudo ufw status`
- 检查Docker容器是否正常运行: `docker ps`
- 检查端口是否正确监听: `netstat -tlnp | grep :3001`

### 3. 部分端口可访问，部分不可访问
- 逐个检查每个端口的安全组规则
- 确认Docker容器的端口映射是否正确

## 安全建议

### 生产环境优化
1. **限制MySQL访问**: 3307端口只允许特定IP访问
2. **限制SSH访问**: 22端口只允许管理员IP访问
3. **使用HTTPS**: 配置SSL证书，使用443端口

### 推荐的生产环境安全组配置
| 类型 | 协议端口 | 来源 | 策略 | 备注 |
|------|----------|------|------|------|
| HTTP | TCP:80 | 0.0.0.0/0 | 允许 | 前端访问 |
| HTTPS | TCP:443 | 0.0.0.0/0 | 允许 | 前端HTTPS访问 |
| 自定义 | TCP:3001 | 0.0.0.0/0 | 允许 | 后端API访问 |
| SSH | TCP:22 | 你的IP/32 | 允许 | SSH管理访问 |
| 自定义 | TCP:3307 | 你的IP/32 | 允许 | 数据库管理访问 |

## 验证脚本

保存以下脚本为 `test_external_access.sh` 并运行：

```bash
#!/bin/bash
SERVER_IP="114.92.153.131"

echo "测试外部访问..."
echo "=================="

echo "1. 测试前端 (端口80):"
curl -I -m 10 http://$SERVER_IP/ && echo "✅ 前端访问正常" || echo "❌ 前端访问失败"

echo "2. 测试后端健康检查 (端口3001):"
curl -m 10 http://$SERVER_IP:3001/health && echo "✅ 后端访问正常" || echo "❌ 后端访问失败"

echo "3. 测试登录API:"
curl -X POST -m 10 http://$SERVER_IP:3001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"userId": "ST001", "password": "Hello888"}' && echo "✅ 登录API正常" || echo "❌ 登录API失败"

echo "=================="
echo "如果所有测试都失败，请检查腾讯云安全组配置"
```

## 联系支持

如果按照以上步骤操作后仍然无法解决问题，可能需要：
1. 联系腾讯云技术支持
2. 检查是否有其他网络策略限制
3. 确认服务器的网络配置是否正确
